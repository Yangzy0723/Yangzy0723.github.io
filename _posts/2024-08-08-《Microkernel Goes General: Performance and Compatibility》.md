---
layout: mypost
title: 《Microkernel Goes General： Performance and Compatibility in the HongMeng Production Microkernel》
categories: [论文阅读]
---
# 《Microkernel Goes General： Performance and Compatibility in the HongMeng Production Microkernel》

**[原文](osdi24-chen-haibo.pdf)**

- 商业实用性：兼容Linux API/ABI以复用其生态（程序和驱动）

- 与传统微内核相比的优化点：
    - IPC
    - capability-based access control
    - userspace paging

- 性能方面遇到的问题：
    - per-invocation IPC
    - IPC frequency, state double bookkeeping among OS services
    - capabilities that hide kernel objects

- 解决方案：
    - differentiated isolation classes
    - flexible composition, policy-free kernel paging, address-token-based access control

## 1. Introduction

**微内核的特征**：微内核将内核中的功能最小化，并将文件系统和设备驱动程序等组件移动到隔离良好、特权最低的操作系统服务中，从而实现了比Linux等单片内核更好的可靠性、安全性和可扩展性。

**单内核（Linux）存在的不足**：
- 像Linux这样的单内核在服务器和云等通用场景中占主导地位，但越来越多的新兴场景，如智能汽车和智能手机，除了良好的性能外，还需要更好的安全性、可靠性和可扩展性，而Linux则不太适合。
- 虽然Linux是通用的，但它更多地向服务器和云发展，使其他场景变得不那么有益。

**微内核（SOTA）存在的不足**：
- SOTA微内核主要针对一些特定领域，例如嵌入式和安全关键领域。它们通常使用静态资源分区和分配，缺乏运行商用现成应用程序的通用操作系统功能。

**微内核改造为通用OS内核面临的主要挑战**：
- Compatibility
- Performance: 当前微内核会造成不晓得性能开销，当微内核被更广泛使用时，IPC频率显著增加（智能手机中的IPC频率比路由器高70倍）

*Capability-based access control*：
    *Capability被简单地称为“密钥”，它是指定资源并授权对其进行某种访问的单一事物。该Capability是不可伪造的权威令牌。*
    *假设有一个文件系统，文件A有如下权限:*   
    - 用户U1可以读和写
    - 用户U2可以读
    *在能力模型中，这些权限将由不同的能力来表示：*
    - 能力C1：允许U1对文件A进行读写操作
    - 能力C2：允许U2对文件A进行读取操作
    *这些能力可以被系统安全地分发和管理。若U1需要将读取权限传递给U3，系统可以创建一个新的能力C3，仅包含读取权限，并将其安全地传递给U3。*

**HongMeng做出的关键设计决策：**
- *具有最低权限和良好隔离的操作系统服务的最小微内核。* HM保留了最小化原则，仅在核心内核中保留必要的功能，包括线程调度程序、serial/timer驱动程序和访问控制，并将所有其他组件作为独立的操作系统服务（多服务器）保留在核心内核之外。
- *通过实现 Linux API/ABI 兼容性和高性能驱动程序复用来最大化兼容性。* HM 通过ABI兼容的shim（shim是一个库，它透明地拦截API调用并更改传递的参数、处理操作本身或将操作重定向到其他地方。Shims 可用于支持较新环境中的旧API，或较旧环境中的新API。shim还可以用于在与开发目的不同的软件平台上运行程序。）来实现完全的Linux API/ABI兼容性，该shim识别并将Linux系统调用重定向到IPC。
- *通过结构性支持优先考虑性能。* HM实现了灵活的组合，以分层放松受信服务之间的隔离，从而最小化IPC开销，并将紧密耦合的服务合并以最小化IPC频率并消除在性能需求场景中的状态双重记账，同时在安全关键场景中保持分离它们的能力。HM还使用基于地址令牌的高性能访问控制来补充基于能力的访问控制，从而促进高效协作操作，例如无策略的内核分页。

## 2. The Case for a General Microkernel

**2.1 回顾微内核**：
- 微内核的一个主要特点是最小化原则，它将核心内核中的功能最小化，并将其他功能移至用户空间服务。**微内核本质上比宏内核更安全、更可靠、更可扩展。**
- 当前微内核主要应用领域还在嵌入式和安全关键系统上，关于如何**将微内核扩展为智能汽车和智能手机等新兴场景**的通用操作系统内核的研究很少。
- 工业界常采用**混合内核**，将核心微内核（例如 XNU 中的 Mach）与内核空间中的所有其他服务（作为一个整体）结合起来。尽管混合内核也最小化了核心内核中的功能，但它们并没有继承微内核的许多优点。例如，混合内核中的操作系统服务不仅不是特权不是最小化的，而且隔离也不好。因此，任何受损或有缺陷的操作系统服务都可能损坏系统，导致严重后果，例如损坏用户数据。

**2.2 通用微内核的需求**：
- 软件生态（POSIX兼容性、Linux ABI兼容性）
- 高效的资源管理和公平的资源分配
- 在特定领域的场景中，微内核优先考虑安全性和严格的资源（例如时间）隔离，主要用于静态应用程序，其中性能不是主要关注点。然而，**在新兴场景中，性能也是首要任务，这直接决定了用户体验，从而影响内核的广泛部署**

**2.3 Linux操作系统存在的问题**

Linux已经主导了服务器和云市场，并且越来越多地渗透到PC和嵌入式等其他领域。然而，它是以牺牲安全性、可靠性和性能为代价的，特别是在新兴场景中。

- **安全和可靠性** 文件系统 (FS) 和设备驱动程序等Linux模块覆盖了其3000万行代码库的大约80%。它们造成了大多数缺陷和漏洞（过去4年中1000个CVE总数的90%），并显着降低了可靠性和安全性。**通过适当的隔离可以避免这些泄露。**
- **通用性与专业化** 虽然Linux目标是通用场景，但最近的补丁和功能表明，创新主要由服务器和云计算驱动，这甚至会影响其他场景的性能。（有专用于服务器/云计算的趋势）。定制内核通用难度大。
- **定制化 vs. 演变** 与上游同步需要大量的努力来重新应用更改，而不与上游同步可能会使系统暴露于安全漏洞中。因此Linux的可定制性受到限制。

*“与上游同步”是指保持软件或代码基的更新和维护，与其原始或主版本（即“上游”版本）保持一致。这通常应用于开源软件项目，其中“上游”是指软件的官方源头或主要开发者发布的版本。例如，在Linux内核开发中，当开发者对内核进行特定的定制时，保持与上游版本的同步意味着定期将上游的更新（如bug修复、安全补丁和新功能）合并到他们的定制版本中。*

## 3. Revisiting Microkernel for Going General

### 3.1 Microkernel at Scale

![](1.png)

观察：
- **新兴场景中IPC频率迅速增加**
    - 图(a)显示了智能手机和车辆的IPC频率远高于路由器
    - 高IPC频率的原因不仅是更高的系统调用频率（61k/s，比路由器高13倍），还有发起了大量文件操作（IPC到文件系统）和触发了内存映射文件的多个page fault（5k/s）
- **分布式多服务端导致状态双重记账**
    - 最小化原则决定了没有用于共享对象（如文件描述符(fd)和页缓存）的集中式存储库，而是将这些对象分布在多个地方

![](2.png)

- **能力（Capabilities）阻碍了高效的协作**
    - 将内核对象隐藏在其背后的能力（Capabilities）由于某些内核对象（例如页表）的频繁更新而引入了显着的性能开销，并阻碍了它们之间的高效协作。

- **生态兼容性要求不仅仅是POSIX合规性**
- **在新兴场景中部署需要高效的驱动程序复用**

### 3.2 Overview of HongMeng

HM遵循微内核的核心设计原则，但又不至于极端，通过谨慎的妥协来解决新兴场景中的性能和兼容性挑战。

![](3.png)
